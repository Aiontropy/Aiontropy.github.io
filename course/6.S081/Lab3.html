<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: page tables | Aiontropy</title>
    <meta name="description" content="blog">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/assets/style.BOSx6zLo.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.DcnFVaJ2.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.IaJf7RXr.js">
    <link rel="modulepreload" href="/assets/chunks/framework.tuuL-SzM.js">
    <link rel="modulepreload" href="/assets/course_6.S081_Lab3.md.BmAvdEV6.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5d98c3a5><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0b0ada53></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0b0ada53>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5d98c3a5 data-v-ae24b3ad><div class="VPNavBar" data-v-ae24b3ad data-v-6aa21345><div class="wrapper" data-v-6aa21345><div class="container" data-v-6aa21345><div class="title" data-v-6aa21345><div class="VPNavBarTitle has-sidebar" data-v-6aa21345 data-v-1168a8e4><a class="title" href="/" data-v-1168a8e4><!--[--><!--]--><!----><span data-v-1168a8e4>Aiontropy</span><!--[--><!--]--></a></div></div><div class="content" data-v-6aa21345><div class="content-body" data-v-6aa21345><!--[--><!--]--><div class="VPNavBarSearch search" data-v-6aa21345><!----></div><!----><!----><div class="VPNavBarAppearance appearance" data-v-6aa21345 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-6aa21345 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://aiontropy.github.io/" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-6aa21345 data-v-bb2aa2f0 data-v-cf11d7a2><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-cf11d7a2><span class="vpi-more-horizontal icon" data-v-cf11d7a2></span></button><div class="menu" data-v-cf11d7a2><div class="VPMenu" data-v-cf11d7a2 data-v-b98bc113><!----><!--[--><!--[--><!----><div class="group" data-v-bb2aa2f0><div class="item appearance" data-v-bb2aa2f0><p class="label" data-v-bb2aa2f0>Appearance</p><div class="appearance-action" data-v-bb2aa2f0><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bb2aa2f0 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bb2aa2f0><div class="item social-links" data-v-bb2aa2f0><div class="VPSocialLinks social-links-list" data-v-bb2aa2f0 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://aiontropy.github.io/" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-bd121fe5><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-6aa21345 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-6aa21345><div class="divider-line" data-v-6aa21345></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5d98c3a5 data-v-a6f0e41e><div class="container" data-v-a6f0e41e><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-a6f0e41e><span class="vpi-align-left menu-icon" data-v-a6f0e41e></span><span class="menu-text" data-v-a6f0e41e>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-a6f0e41e data-v-8a42e2b4><button data-v-8a42e2b4>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5d98c3a5 data-v-319d5ca6><div class="curtain" data-v-319d5ca6></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-319d5ca6><span class="visually-hidden" id="sidebar-aria-label" data-v-319d5ca6> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0" data-v-c40bc020 data-v-b3fd67f8><div class="item" role="button" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><h2 class="text" data-v-b3fd67f8>base</h2><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/base/operating_systems/operating_systems" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>operating systems</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-c40bc020><section class="VPSidebarItem level-0" data-v-c40bc020 data-v-b3fd67f8><div class="item" role="button" tabindex="0" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><h2 class="text" data-v-b3fd67f8>coursei</h2><!----></div><div class="items" data-v-b3fd67f8><!--[--><div class="VPSidebarItem level-1 is-link" data-v-b3fd67f8 data-v-b3fd67f8><div class="item" data-v-b3fd67f8><div class="indicator" data-v-b3fd67f8></div><a class="VPLink link link" href="/course/6.S081/6.S081" data-v-b3fd67f8><!--[--><p class="text" data-v-b3fd67f8>6.S081</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5d98c3a5 data-v-1428d186><div class="VPDoc has-sidebar has-aside" data-v-1428d186 data-v-39a288b8><!--[--><!--]--><div class="container" data-v-39a288b8><div class="aside" data-v-39a288b8><div class="aside-curtain" data-v-39a288b8></div><div class="aside-container" data-v-39a288b8><div class="aside-content" data-v-39a288b8><div class="VPDocAside" data-v-39a288b8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-a5bbad30><div class="content" data-v-a5bbad30><div class="outline-marker" data-v-a5bbad30></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-a5bbad30>On this page</div><ul class="VPDocOutlineItem root" data-v-a5bbad30 data-v-b933a997><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-39a288b8><div class="content-container" data-v-39a288b8><!--[--><!--]--><main class="main" data-v-39a288b8><div style="position:relative;" class="vp-doc _course_6_S081_Lab3" data-v-39a288b8><div><h1 id="lab-page-tables" tabindex="-1">Lab: page tables <a class="header-anchor" href="#lab-page-tables" aria-label="Permalink to &quot;Lab: page tables&quot;">​</a></h1><h2 id="speed-up-system-calls-easy" tabindex="-1">Speed up system calls(easy) <a class="header-anchor" href="#speed-up-system-calls-easy" aria-label="Permalink to &quot;Speed up system calls(easy)&quot;">​</a></h2><p><strong>实验思路</strong></p><ol><li>首先是看 <em>kernel/memlayout.h</em> ，能看到里面有一个 <code>USYSCALL</code> 的宏，还有一个 <code>struct usyscall</code> 的结构体，看题能知道，这题就是希望使用这个 <code>usyscall</code> 让用户态的程序获取 pid 的时候不切换内核态</li><li>根据提示，找到 <em>kernel/proc.c</em> 的 <code>proc_pagetable()</code> 函数，在这里可以实现映射，根据上一条思路，和这里的这个函数一起观看会发现，这个函数还实现了了另外两个宏的映射，因此，模仿着它的映射，就可以了。但是会发现 <code>proc</code> 结构体里没有宏对应的变量，因此需要手动添加一个</li><li>提示里还说要注意选择权限的比特位，由于不知道权限的比特位，需要看一下书，看完书就知道比特位在 <em>kernel/riskv.h</em> 中也有宏的定义，直接使用就好了</li><li>根据提示，在 <code>allocproc()</code> 函数中，需要初始化 <code>usyscall</code> ，同时也能看到这个函数里初始化另外一个宏，在它下面模仿着初始化就可以了</li><li>根据提示，和上一条思路一样修改方法，修改 <code>freeproc()</code></li><li>这时候运行会出现 <code>panic: freewalk: leaf</code> 的错误，看到 <strong>free</strong> ，猜到也许是 <code>freeproc()</code> 的问题，仔细看修改过的代码，没发现什么问题，由于改动和页表相关，去看一下 <code>proc_freepagetable()</code> ，发现这里没有 ummap USYSCALL ，添加一条 ummap USYSCALL 就可以了</li></ol><p><strong>踩到的坑</strong></p><ol><li>在 <code>allocproc()</code> 函数中，我把初始化 usyscall 写到了初始化页表后面，导致初始化页表出现了缺页异常，找了了十分久才发现</li></ol><h2 id="print-a-page-table-easy" tabindex="-1">Print a page table(easy) <a class="header-anchor" href="#print-a-page-table-easy" aria-label="Permalink to &quot;Print a page table(easy)&quot;">​</a></h2><p><strong>实验思路</strong></p><ol><li>定义一个 <code>vmprint()</code> 函数在 <em>kernel/vm.c</em> 中，由于是打印页表，因此参数就是一个页表</li><li>根据示例，直接使用 <code>%p</code> 打印第一行地址，也就是页表的第一条地址</li><li>页表的转换需要使用位运算，这个在 <em>kernel/riscv.h</em> 中有宏定义好了，页表的其他信息里面也有宏定义好了，直接调用即可</li><li>参考 <code>freewalk()</code> 函数，是释放页表，释放页表需要遍历，因此可以直接将整个函数复制过来修改，但是由于需要递归操作，所以新建一个<code>_print_pgtbl()</code> 函数，将 <code>freewalk()</code> 复制进去，新函数的参数是页表和层级，层级用于判断递归的层数</li><li>页表中有一个位是 <code>PTE_V</code> ，在 <em>kernel/riscv.h</em> 可以得知，这个位是判断页表是否有效的。对于无效的页表，直接跳过就好，对于有效的页表，直接按格式打印层级和地址</li><li>打印完之后需要判断该页表是不是叶子的页表，判断的方法通过课程或者 xv6 book 可以知道，当 <code>PTE_R PTE_W PTE_X</code> 都等于 0 的时候，页表有子页表，否则是叶子页表，如果不是叶子页表，直接递归同时层级加一就行了</li></ol></div></div></main><footer class="VPDocFooter" data-v-39a288b8 data-v-e257564d><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><!----></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/base/operating_systems/operating_systems" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>operating systems</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api-examples.md\":\"Bom9wPq4\",\"base_operating_systems_operating_systems.md\":\"CAfFIrvc\",\"computer_sciences_blockchain_index.md\":\"BOp_s8bf\",\"computer_sciences_blockchain_part_1_basic_blackchain.md\":\"DHFIjGFH\",\"computer_sciences_blockchain_part_2_proof_of_work.md\":\"Bqge3pz1\",\"computer_sciences_blockchain_part_3_persistence_and_cli.md\":\"CzIuTcZg\",\"computer_sciences_blockchain_part_4_transactions1.md\":\"BBtqn8VB\",\"computer_sciences_blockchain_part_5_addresses.md\":\"Dd4GjrXA\",\"course_6.s081_another.md\":\"BblGHekO\",\"course_6.s081_course_note_p1.md\":\"BeHNdOv6\",\"course_6.s081_course_note_p3.md\":\"CMbVjxu1\",\"course_6.s081_course_note_p4.md\":\"DgjJafgJ\",\"course_6.s081_index.md\":\"Ba4ZUyrW\",\"course_6.s081_lab1.md\":\"BhAhSEoU\",\"course_6.s081_lab2.md\":\"pP_pa4BJ\",\"course_6.s081_lab3.md\":\"BmAvdEV6\",\"index.md\":\"B_juNalC\",\"markdown-examples.md\":\"Cglqg7tx\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Aiontropy\",\"description\":\"blog\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"sidebar\":[{\"text\":\"base\",\"items\":[{\"text\":\"operating systems\",\"link\":\"/base/operating_systems/operating_systems\"}]},{\"text\":\"coursei\",\"items\":[{\"text\":\"6.S081\",\"link\":\"/course/6.S081/6.S081\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://aiontropy.github.io/\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":true}");</script>
    
  </body>
</html>